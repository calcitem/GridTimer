# 权限请求功能实现

## 概述

本次更新实现了应用启动时的自动权限请求功能，以及设置页面中的权限管理功能，确保用户能够正确授予应用所需的权限，从而保证锁屏时的声音提醒功能正常工作。

## 实现的功能

### 1. 应用启动时自动请求权限

**修改文件**：`lib/main.dart`

**功能说明**：
- 在应用初始化服务之前，自动请求通知权限
- 会弹出系统权限对话框，询问用户是否允许通知
- 同时尝试请求精确闹钟权限（Android 14+）

**代码改动**：
```dart
Future<void> _initializeServices() async {
  try {
    // 首先请求通知权限（Android 13+）
    final notification = ref.read(notificationServiceProvider);
    await notification.init();
    
    // 主动请求通知权限
    await notification.requestPostNotificationsPermission();
    
    // 尝试请求精确闹钟权限（Android 14+，用户可能需要手动授予）
    await notification.requestExactAlarmPermission();
    
    // ... 继续初始化其他服务
  }
}
```

### 2. 设置页面权限管理

**修改文件**：`lib/presentation/pages/settings_page.dart`

**新增功能**：

#### 通知权限
- **显示**：权限名称和说明
- **操作**：点击"授予权限"按钮直接请求
- **反馈**：显示授予成功或失败的提示

#### 精确闹钟权限
- **显示**：权限名称和说明（确保计时器准时提醒）
- **操作**：点击"设置"按钮打开系统设置页面
- **适用**：Android 14+ 需要用户手动在系统设置中授予

#### 电池优化设置
- **显示**：设置名称和说明（关闭电池优化以确保后台提醒可靠）
- **操作**：点击"设置"按钮打开电池优化设置页面
- **建议**：引导用户将应用加入电池优化白名单

## 权限说明

### 1. 通知权限（POST_NOTIFICATIONS）

**重要性**：⭐⭐⭐⭐⭐ 必需

**用途**：
- 显示计时器到时间的通知
- 在锁屏状态下播放声音
- 提供停止按钮

**请求时机**：
- 应用首次启动时自动请求
- 设置页面可手动请求

**系统要求**：
- Android 13 (API 33) 及以上版本需要运行时请求
- 更早版本自动授予

### 2. 精确闹钟权限（SCHEDULE_EXACT_ALARM）

**重要性**：⭐⭐⭐⭐ 推荐

**用途**：
- 确保计时器在准确的时间触发
- 提高后台提醒的可靠性

**请求时机**：
- 应用启动时尝试请求
- 设置页面可打开系统设置

**系统要求**：
- Android 14 (API 34) 及以上版本默认拒绝
- 需要用户在系统设置中手动授予

**注意**：
- 如果未授予，应用会降级使用非精确闹钟
- 可能会有几秒到几分钟的延迟

### 3. 全屏提醒权限（USE_FULL_SCREEN_INTENT）

**重要性**：⭐⭐⭐ 可选

**用途**：
- 在锁屏时唤醒屏幕
- 显示全屏提醒界面
- 提供更明显的提醒效果

**当前状态**：
- 已在 `AndroidManifest.xml` 中声明
- Android 14+ 可能需要用户手动授予

### 4. 电池优化豁免

**重要性**：⭐⭐⭐⭐ 推荐

**用途**：
- 防止应用在后台被系统杀死
- 确保计时器在后台继续运行
- 保证到时间时能够触发提醒

**请求方式**：
- 只能引导用户在系统设置中手动关闭
- 应用无法直接请求

## 用户体验流程

### 首次启动

1. 用户打开应用
2. **自动弹出通知权限对话框**
3. 用户点击"允许"或"拒绝"
4. 如果允许：✅ 可以正常使用所有提醒功能
5. 如果拒绝：⚠️ 无法显示通知和播放声音

### 权限被拒绝后

如果用户之前拒绝了通知权限：

1. 前往"设置"页面
2. 找到"权限"部分
3. 点击"通知权限"旁的"授予权限"按钮
4. 再次弹出系统权限对话框
5. 或者如果系统不再弹出，会自动打开应用设置页面

### 优化后台可靠性

建议用户完成以下设置：

1. ✅ 授予通知权限（必需）
2. ✅ 授予精确闹钟权限（推荐，Android 14+）
3. ✅ 关闭电池优化（推荐）
4. ⭕ 授予全屏提醒权限（可选）

## 技术实现细节

### 权限请求流程

```
应用启动
    ↓
初始化通知服务
    ↓
请求通知权限 ← 弹出对话框
    ↓
请求精确闹钟权限 ← 可能打开设置
    ↓
初始化其他服务
    ↓
应用正常运行
```

### 权限状态检查

应用使用以下服务检查权限状态：

- `INotificationService.requestPostNotificationsPermission()` - 请求通知权限
- `INotificationService.requestExactAlarmPermission()` - 请求精确闹钟权限
- `IPermissionService.canPostNotifications()` - 检查通知权限状态
- `IPermissionService.canScheduleExactAlarms()` - 检查精确闹钟权限状态

### 设置页面打开方式

- `openNotificationSettings()` - 打开通知设置
- `openExactAlarmSettings()` - 打开闹钟设置
- `openBatteryOptimizationSettings()` - 打开电池优化设置
- `openAppSettings()` - 打开应用信息页面

## 测试建议

### 测试场景 1：首次安装

1. 卸载应用（如果已安装）
2. 重新安装应用
3. 打开应用
4. **预期**：应该立即弹出通知权限对话框
5. 点击"允许"
6. **验证**：权限已授予，应用正常运行

### 测试场景 2：拒绝权限后重新授予

1. 首次启动时点击"拒绝"
2. 前往设置页面
3. 点击"通知权限"旁的"授予权限"
4. **预期**：再次弹出权限对话框或打开应用设置
5. 授予权限
6. **验证**：启动一个计时器，锁屏后应该能听到声音

### 测试场景 3：精确闹钟设置（Android 14+）

1. 在设置页面点击"精确闹钟权限"旁的"设置"
2. **预期**：打开系统的闹钟与提醒设置页面
3. 找到应用名称，开启权限
4. 返回应用
5. **验证**：计时器应该更准时地触发

### 测试场景 4：电池优化设置

1. 在设置页面点击"电池优化设置"旁的"设置"
2. **预期**：打开系统的电池优化设置页面
3. 找到应用，选择"不优化"
4. 返回应用
5. **验证**：锁屏并等待一段时间，计时器应该能正常触发

## 常见问题

### Q1: 为什么没有弹出权限对话框？

**可能原因**：
1. 您之前已经授予或拒绝过权限
2. Android 版本低于 13，不需要运行时请求
3. 权限请求被系统限制（多次拒绝后）

**解决方案**：
- 前往设置页面，点击"授予权限"按钮
- 或者在系统设置中手动授予

### Q2: 授予权限后锁屏还是没声音？

**检查清单**：
1. ✅ 通知权限已授予
2. ✅ 手机没有开启勿扰模式
3. ✅ 手机音量没有静音
4. ✅ 应用没有被电池优化限制

**解决方案**：
- 检查系统设置中的勿扰模式
- 调高媒体音量或通知音量
- 关闭应用的电池优化

### Q3: Android 14 设备计时器不准时？

**原因**：
- 未授予精确闹钟权限
- 应用使用非精确闹钟模式

**解决方案**：
1. 前往设置页面
2. 点击"精确闹钟权限"旁的"设置"
3. 在系统设置中授予权限

### Q4: 应用在后台被杀死？

**原因**：
- 部分手机厂商（小米、华为等）的系统会积极杀死后台应用
- 电池优化策略过于激进

**解决方案**：
1. 关闭应用的电池优化
2. 在系统设置中将应用加入自启动白名单
3. 在后台管理中设置为"无限制"

## 相关文件

### 修改的文件
- `lib/main.dart` - 添加启动时权限请求
- `lib/presentation/pages/settings_page.dart` - 改进权限管理界面

### 相关文件
- `lib/infrastructure/notification_service.dart` - 通知权限请求实现
- `lib/infrastructure/permission_service.dart` - 权限服务实现
- `lib/core/domain/services/i_notification_service.dart` - 通知服务接口
- `lib/core/domain/services/i_permission_service.dart` - 权限服务接口
- `android/app/src/main/AndroidManifest.xml` - 权限声明

## 修复版本信息

- **修复日期**：2025-12-31
- **影响版本**：1.0.0+
- **修复类型**：功能增强 + Bug 修复
- **相关问题**：锁屏时无法发声提醒、权限未请求

